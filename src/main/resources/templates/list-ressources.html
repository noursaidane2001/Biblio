<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des ressources - Biblio</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link th:href="@{/css/custom.css}" rel="stylesheet">
</head>
<body class="bg-light">
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="~{fragments/toasts :: toast-container}"></div>

    <div class="container py-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/bibliothecaire/dashboard}" class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Liste des ressources</li>
            </ol>
        </nav>

        <!-- Titre et actions -->
        <div class="card shadow-lg border-0 mb-4">
            <div class="card-body p-4">
                <div class="d-flex flex-wrap align-items-center justify-content-between">
                    <div class="d-flex align-items-center mb-3 mb-md-0">
                        <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 60px; height: 60px;">
                            <i class="bi bi-journal-text text-info" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h1 class="h3 fw-bold text-info mb-1">Liste des ressources</h1>
                            <p class="text-muted mb-0">Gérez et consultez toutes les ressources de votre bibliothèque</p>
                        </div>
                    </div>
                    <div>
                        <a th:href="@{/ressources/new}" class="btn btn-info">
                            <i class="bi bi-plus-circle me-2"></i>Ajouter une ressource
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et recherche -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Rechercher par titre, auteur, ISBN...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categorieFilter">
                            <option value="">Toutes les catégories</option>
                            <option value="LITTERATURE">Littérature</option>
                            <option value="SCIENCES">Sciences</option>
                            <option value="MULTIMEDIA">Multimédia</option>
                            <option value="HISTOIRE">Histoire</option>
                            <option value="TECHNOLOGIE">Technologie</option>
                            <option value="ARTS">Arts</option>
                            <option value="JEUNESSE">Jeunesse</option>
                            <option value="PHILOSOPHIE">Philosophie</option>
                            <option value="ECONOMIE">Économie</option>
                            <option value="DROIT">Droit</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="typeFilter">
                            <option value="">Tous les types</option>
                            <option value="LIVRE">Livre</option>
                            <option value="DVD">DVD</option>
                            <option value="CD">CD</option>
                            <option value="REVUE">Revue</option>
                            <option value="EBOOK">E-Book</option>
                            <option value="AUDIOBOOK">Livre Audio</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="disponibiliteFilter">
                            <option value="">Toutes</option>
                            <option value="disponible">Disponibles</option>
                            <option value="indisponible">Indisponibles</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone de chargement -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="text-muted mt-2">Chargement des ressources...</p>
        </div>

        <!-- Statistiques -->
        <div id="statsContainer" class="row g-4 mb-4" style="display: none;">
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-book text-info" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Ressources</div>
                            <div class="h5 mb-0" id="totalRessources">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-check-circle text-success" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Disponibles</div>
                            <div class="h5 mb-0" id="totalDisponibles">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-stack text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Exemplaires</div>
                            <div class="h5 mb-0" id="totalExemplaires">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-grid text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <div class="text-muted small">Catégories</div>
                            <div class="h5 mb-0" id="totalCategories">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des ressources -->
        <div id="ressourcesContainer" class="row g-4" style="display: none;">
            <!-- Les cartes de ressources seront insérées ici dynamiquement -->
        </div>

        <!-- Message si aucune ressource -->
        <div id="noRessources" class="card shadow-sm border-0" style="display: none;">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">Aucune ressource trouvée</h4>
                <p class="text-muted">Commencez par ajouter votre première ressource</p>
                <a th:href="@{/ressources/new}" class="btn btn-info mt-2">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter une ressource
                </a>
            </div>
        </div>
    </div>

    <!-- Modal de détails -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="detailsModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Détails de la ressource
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Le contenu sera inséré dynamiquement -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <script>
        let allRessources = [];
        let filteredRessources = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadRessources();
            
            // Événements de filtrage
            document.getElementById('searchInput').addEventListener('input', filterRessources);
            document.getElementById('categorieFilter').addEventListener('change', filterRessources);
            document.getElementById('typeFilter').addEventListener('change', filterRessources);
            document.getElementById('disponibiliteFilter').addEventListener('change', filterRessources);
        });

        async function loadRessources() {
            try {
                const response = await fetch('/api/ressources');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    allRessources = result.ressources || [];
                    filteredRessources = [...allRessources];
                    displayRessources();
                    updateStats();
                } else {
                    showError('Erreur lors du chargement des ressources');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Impossible de charger les ressources');
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayRessources() {
            const container = document.getElementById('ressourcesContainer');
            const noRessources = document.getElementById('noRessources');
            
            if (filteredRessources.length === 0) {
                container.style.display = 'none';
                noRessources.style.display = 'block';
                document.getElementById('statsContainer').style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            noRessources.style.display = 'none';
            document.getElementById('statsContainer').style.display = 'flex';
            
            container.innerHTML = filteredRessources.map(ressource => createRessourceCard(ressource)).join('');
            
            // Ajouter les événements de clic pour les détails
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', function() {
                    const ressourceId = this.dataset.ressourceId;
                    const ressource = allRessources.find(r => r.id == ressourceId);
                    showDetails(ressource);
                });
            });
        }

        function createRessourceCard(ressource) {
            const disponible = ressource.exemplairesDisponibles > 0;
            const categorieLabel = getCategorieLabel(ressource.categorie);
            const typeLabel = getTypeLabel(ressource.typeRessource);
            
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0 hover-shadow">
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                ${ressource.imageCouverture ? 
                                    `<img src="${ressource.imageCouverture}" alt="${ressource.titre}" 
                                         class="img-thumbnail me-3" style="width: 80px; height: 120px; object-fit: cover;">` :
                                    `<div class="bg-secondary bg-opacity-10 me-3 d-flex align-items-center justify-content-center" 
                                         style="width: 80px; height: 120px;">
                                        <i class="bi bi-book text-secondary" style="font-size: 2rem;"></i>
                                    </div>`
                                }
                                <div class="flex-grow-1">
                                    <h5 class="card-title text-truncate mb-1" title="${ressource.titre}">
                                        ${ressource.titre}
                                    </h5>
                                    <p class="text-muted small mb-2">
                                        <i class="bi bi-person me-1"></i>${ressource.auteur}
                                    </p>
                                    <div class="d-flex flex-wrap gap-1">
                                        <span class="badge bg-info">${categorieLabel}</span>
                                        <span class="badge bg-secondary">${typeLabel}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${ressource.isbn ? `<p class="small text-muted mb-2"><i class="bi bi-upc me-1"></i>ISBN: ${ressource.isbn}</p>` : ''}
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="small text-muted">Disponibilité</span>
                                    <span class="badge ${disponible ? 'bg-success' : 'bg-danger'}">
                                        ${disponible ? 'Disponible' : 'Indisponible'}
                                    </span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar ${disponible ? 'bg-success' : 'bg-danger'}" 
                                         role="progressbar" 
                                         style="width: ${(ressource.exemplairesDisponibles / ressource.nombreExemplaires) * 100}%"
                                         aria-valuenow="${ressource.exemplairesDisponibles}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="${ressource.nombreExemplaires}">
                                    </div>
                                </div>
                                <small class="text-muted">
                                    ${ressource.exemplairesDisponibles} / ${ressource.nombreExemplaires} exemplaires disponibles
                                </small>
                            </div>
                            
                            <div class="d-grid">
                                <button class="btn btn-outline-info btn-sm view-details" data-ressource-id="${ressource.id}">
                                    <i class="bi bi-eye me-2"></i>Voir les détails
                                </button>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Ajouté le ${formatDate(ressource.dateAjout)}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        function showDetails(ressource) {
            const modalBody = document.getElementById('modalBody');
            const categorieLabel = getCategorieLabel(ressource.categorie);
            const typeLabel = getTypeLabel(ressource.typeRessource);
            const disponible = ressource.exemplairesDisponibles > 0;
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center mb-3 mb-md-0">
                        ${ressource.imageCouverture ? 
                            `<img src="${ressource.imageCouverture}" alt="${ressource.titre}" 
                                 class="img-fluid rounded shadow" style="max-height: 300px;">` :
                            `<div class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center" 
                                 style="height: 300px;">
                                <i class="bi bi-book text-secondary" style="font-size: 5rem;"></i>
                            </div>`
                        }
                    </div>
                    <div class="col-md-8">
                        <h4 class="fw-bold mb-3">${ressource.titre}</h4>
                        
                        <table class="table table-borderless">
                            <tr>
                                <td class="text-muted" style="width: 40%;"><i class="bi bi-person me-2"></i>Auteur:</td>
                                <td class="fw-semibold">${ressource.auteur}</td>
                            </tr>
                            ${ressource.isbn ? `
                            <tr>
                                <td class="text-muted"><i class="bi bi-upc me-2"></i>ISBN:</td>
                                <td>${ressource.isbn}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td class="text-muted"><i class="bi bi-tag me-2"></i>Catégorie:</td>
                                <td><span class="badge bg-info">${categorieLabel}</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted"><i class="bi bi-collection me-2"></i>Type:</td>
                                <td><span class="badge bg-secondary">${typeLabel}</span></td>
                            </tr>
                            ${ressource.editeur ? `
                            <tr>
                                <td class="text-muted"><i class="bi bi-building me-2"></i>Éditeur:</td>
                                <td>${ressource.editeur}</td>
                            </tr>
                            ` : ''}
                            ${ressource.datePublication ? `
                            <tr>
                                <td class="text-muted"><i class="bi bi-calendar me-2"></i>Date de publication:</td>
                                <td>${formatDate(ressource.datePublication)}</td>
                            </tr>
                            ` : ''}
                            <tr>
                                <td class="text-muted"><i class="bi bi-stack me-2"></i>Exemplaires:</td>
                                <td>
                                    <strong class="${disponible ? 'text-success' : 'text-danger'}">
                                        ${ressource.exemplairesDisponibles}
                                    </strong> / ${ressource.nombreExemplaires}
                                    <span class="badge ${disponible ? 'bg-success' : 'bg-danger'} ms-2">
                                        ${disponible ? 'Disponible' : 'Indisponible'}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted"><i class="bi bi-star me-2"></i>Popularité:</td>
                                <td>${ressource.popularite} emprunts</td>
                            </tr>
                        </table>
                        
                        ${ressource.description ? `
                        <div class="mt-3">
                            <h6 class="fw-bold"><i class="bi bi-text-paragraph me-2"></i>Description:</h6>
                            <p class="text-muted">${ressource.description}</p>
                        </div>
                        ` : ''}
                        
                        ${ressource.bibliotheque ? `
                        <div class="mt-3 p-2 bg-light rounded">
                            <small class="text-muted">
                                <i class="bi bi-building me-1"></i>
                                Bibliothèque: <strong>${ressource.bibliotheque.nom}</strong>
                            </small>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }

        function filterRessources() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categorie = document.getElementById('categorieFilter').value;
            const type = document.getElementById('typeFilter').value;
            const disponibilite = document.getElementById('disponibiliteFilter').value;
            
            filteredRessources = allRessources.filter(ressource => {
                const matchSearch = !searchTerm || 
                    ressource.titre.toLowerCase().includes(searchTerm) ||
                    ressource.auteur.toLowerCase().includes(searchTerm) ||
                    (ressource.isbn && ressource.isbn.toLowerCase().includes(searchTerm));
                
                const matchCategorie = !categorie || ressource.categorie === categorie;
                const matchType = !type || ressource.typeRessource === type;
                
                let matchDisponibilite = true;
                if (disponibilite === 'disponible') {
                    matchDisponibilite = ressource.exemplairesDisponibles > 0;
                } else if (disponibilite === 'indisponible') {
                    matchDisponibilite = ressource.exemplairesDisponibles === 0;
                }
                
                return matchSearch && matchCategorie && matchType && matchDisponibilite;
            });
            
            displayRessources();
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalRessources').textContent = filteredRessources.length;
            
            const totalDisponibles = filteredRessources.reduce((sum, r) => sum + r.exemplairesDisponibles, 0);
            document.getElementById('totalDisponibles').textContent = totalDisponibles;
            
            const totalExemplaires = filteredRessources.reduce((sum, r) => sum + r.nombreExemplaires, 0);
            document.getElementById('totalExemplaires').textContent = totalExemplaires;
            
            const categories = new Set(filteredRessources.map(r => r.categorie));
            document.getElementById('totalCategories').textContent = categories.size;
        }

        function getCategorieLabel(categorie) {
            const labels = {
                'LITTERATURE': 'Littérature',
                'SCIENCES': 'Sciences',
                'MULTIMEDIA': 'Multimédia',
                'HISTOIRE': 'Histoire',
                'TECHNOLOGIE': 'Technologie',
                'ARTS': 'Arts',
                'JEUNESSE': 'Jeunesse',
                'PHILOSOPHIE': 'Philosophie',
                'ECONOMIE': 'Économie',
                'DROIT': 'Droit'
            };
            return labels[categorie] || categorie;
        }

        function getTypeLabel(type) {
            const labels = {
                'LIVRE': 'Livre',
                'DVD': 'DVD',
                'CD': 'CD',
                'REVUE': 'Revue',
                'EBOOK': 'E-Book',
                'AUDIOBOOK': 'Livre Audio'
            };
            return labels[type] || type;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function showError(message) {
            const container = document.querySelector('.toast-container') || createToastContainer();
            
            const toastHtml = `
                <div class="toast align-items-center text-bg-danger border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>Erreur</strong><br>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = container.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '11';
            document.body.appendChild(container);
            return container;
        }
    </script>
    
    <style>
        .hover-shadow {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .hover-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
    </style>
</body>
</html>